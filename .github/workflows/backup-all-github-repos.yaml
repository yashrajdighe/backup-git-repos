name: Backup All Github Repositories
run-name: Backup All Github Repositories
on:
  schedule:
    - cron: "0 0 * * *" # Runs daily at 12 AM UTC
permissions:
  id-token: write
  contents: write
env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
jobs:
  create-github-app-token:
    runs-on: ubuntu-latest
    environment: main
    outputs:
      gh-app-token: ${{ steps.create-gh-app-token.outputs.gh-app-token }}
    steps:
      - name: Create GitHub App Token
        id: create-gh-app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_KEY }}
          owner: yashrajdighe
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Generate matrix of repositories
        id: set-matrix
        run: |
          repos=$(gh repo list yashrajdighe --limit 1000 --json nameWithOwner,isFork --jq '.[] | select(.isFork == false) | .nameWithOwner')
          matrix=$(jq -n --arg repos "$repos" '{"include": ($repos | split("\n") | map(select(length > 0) | {repository: .}))}')
          echo "Matrix: $matrix"
          matrix_escaped=$(echo "$matrix" | jq -c .)
          echo "matrix=${matrix_escaped}" >> $GITHUB_OUTPUT
  generate-backup:
    name: Generate Backup for ${{ matrix.repository }} repository
    needs: [generate-matrix, create-github-app-token]
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-region: us-east-1
          role-to-assume: arn:aws:iam::530354880605:role/common-yashrajdighe-git-repo-backup-20251020210229788000000001
          role-session-name: GitHubActionsSession
      - name: Backup GitHub Repository ${{ matrix.repository }}
        uses: yashrajdighe/gh-actions/backup-github-repo@main
        with:
          token: ${{ needs.create-github-app-token.outputs.gh-app-token }}
          repository: ${{ matrix.repository }}

      - name: Checkout repository to update logs
        uses: actions/checkout@v6

      - name: Update backup log for ${{ matrix.repository }}
        env:
          GITHUB_TOKEN: ${{ needs.create-github-app-token.outputs.gh-app-token }}
        run: |
          # full repository name (owner/name)
          repo_full="${{ matrix.repository }}"
          # extract owner and repo name
          owner="${repo_full%%/*}"
          repo_name="${repo_full##*/}"
          dir="log/${owner}/${repo_name}"
          mkdir -p "$dir"
          timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "$timestamp - ${repo_full} - backup successful" >> "$dir/backup.log"

          # configure git and create a branch+PR to update logs (avoid direct pushes to default branch)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$dir/backup.log"
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # create a branch
            ts_branch=$(date -u +%Y%m%d%H%M%S)
            safe_owner=${owner//[^a-zA-Z0-9_-]/_}
            safe_repo=${repo_name//[^a-zA-Z0-9_-]/_}
            branch="backup-log-${safe_owner}-${safe_repo}-${ts_branch}"
            git checkout -b "$branch"
            git commit -m "chore: update backup log for ${repo_full} at ${timestamp}"
            git push --set-upstream origin "$branch"

            # create a PR against the default branch (main) using gh CLI
            pr_title="chore: update backup log for ${repo_full} at ${timestamp}"
            pr_body="Automatic backup log update for ${repo_full} by workflow."

            # Ensure GH CLI uses the provided token
            export GITHUB_TOKEN="${GITHUB_TOKEN}"

            # create PR with gh; parse returned URL to extract PR number (robust across gh versions)
            pr_url=$(gh pr create --title "$pr_title" --body "$pr_body" --base main --head "$branch" --repo "$GITHUB_REPOSITORY" 2>/dev/null || true)
            pr_number=""
            if [ -n "$pr_url" ]; then
              pr_number=$(echo "$pr_url" | sed -E 's#.*/pull/([0-9]+).*#\1#')
            fi

            # If gh returned JSON with number, try that as a fallback
            if [ -z "$pr_number" ]; then
              pr_number=$(gh pr view --repo "$GITHUB_REPOSITORY" --json number --jq .number 2>/dev/null || true)
            fi

            if [ -n "$pr_number" ] && [ "$pr_number" != "null" ]; then
              echo "Created PR #${pr_number}"
              # enable auto-merge using gh (may require additional token permissions)
              gh pr merge "$pr_number" --auto --merge --repo "$GITHUB_REPOSITORY" || echo "Failed to enable auto-merge for PR #${pr_number}; check token permissions"
            else
              echo "Failed to create PR; gh output: $pr_url"
            fi
          fi
